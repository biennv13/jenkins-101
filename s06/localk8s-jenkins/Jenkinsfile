pipeline {
  agent {
    kubernetes {
      label 'runner'  // all your pods will be named with this prefix, followed by a unique id
      idleMinutes 5  // how long the pod will live after no jobs have run on it
      yamlFile 'build-pod.yaml'  // path to the pod definition relative to the root of our project 
      defaultContainer 'python'  // define a default container if more than a few stages use it, will default to jnlp container
    }
  }

  environment {
      // The MY_KUBECONFIG environment variable will be assigned
      // the value of a temporary file.  For example:
      //   /home/user/.jenkins/workspace/cred_test@tmp/secretFiles/546a5cf3-9b56-4165-a0fd-19e2afe6b31f/kubeconfig.txt
      // MY_KUBECONFIG = credentials('my-kubeconfig')
      DOCKERHUB_PW = credentials('dockerhub_pw')
  }
  
  stages {
      stage('Python runner testing') {
          steps {
              sh 'python -V'
          }
      }

      stage('Build Docker Image') {
          steps {
            container('docker') {  
              sh "docker build -t kanchimo/python-simple-app:$BUILD_NUMBER ."
              sh "docker login -u kanchimo -p $DOCKERHUB_PW"
              sh "docker push kanchimo/python-simple-app:$BUILD_NUMBER"
            }
          }
      }
  }
}